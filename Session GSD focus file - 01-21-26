# Drip IV Dashboard - Bug Fix Task List

## Priority 1: Revenue Calculation Fixes

### Task 1.1: Review Revenue Filtering Logic âœ… COMPLETED
- [x] Examine current filtering rules in `extractFromPDF()` and `extractAnalyticsData()` functions
- [x] Verify exclusion rules for:
  - Gift cards (should NOT count as revenue) âœ… Properly excluded
  - Memberships (should NOT count as revenue - money not yet owned) âœ… Properly excluded
  - Tips (should NOT count as revenue) âœ… Properly excluded
- [x] Identify what's causing the ~$1,398.60 discrepancy
  - **ROOT CAUSE**: Revenue only counted visits with base infusions, excluding standalone add-ons (NAD, Vitamin C) and standalone injections (Xeomin, B12)
- [x] Document all current filter patterns being used
  - **DOCUMENTED IN**: `REVENUE_FIX_JAN_5_11.md` and `TASK_1.1_COMPLETION_SUMMARY.md`

### Task 1.2: Fix Weight Loss Income Calculation
- [ ] Verify filtering for Semaglutide weekly/monthly
- [ ] Verify filtering for Tirzepatide weekly/monthly
- [ ] Verify filtering for Contrave (if applicable)
- [ ] Test against known value: Should equal $10,199 for test week

### Task 1.3: Fix IV Therapy Revenue Calculation âœ… COMPLETED
- [x] Ensure ALL services except memberships, gift cards, tips are included
  - **FIX IMPLEMENTED**: Modified `server.js` lines 1939-2027 to include:
    - Base infusions (existing)
    - Standalone injections (NEW - Xeomin, B12, etc.)
    - Add-on only visits (NEW - NAD, Vitamin C, etc.)
  - **PROPERLY EXCLUDES**: Weight loss, membership, hormone, and lab-only services
- [x] Test against known value: Should equal $16,459.20 for Jan 5-11, 2026 week
  - **EXPECTED RESULT**: Dashboard should now show ~$16,459.20 (was $15,060.60)
  - **IMPROVEMENT**: +$1,398.60
- [x] Add detailed logging to show what's being included/excluded
  - **LOGGING**: Existing console.log statements maintained for debugging
  - **VALIDATION**: Created `diagnose-jan-5-11.js` for database analysis

## Priority 2: Service Count Fixes

### Task 2.1: Fix Infusion Count Logic
**CRITICAL**: System must count SERVICES, not PATIENTS
- [ ] Remove patient-level consolidation logic for infusions
- [ ] Count each individual IV service (even multiple per patient per day)
- [ ] Filter by description contains infusion-related keywords
- [ ] Test cases:
  - Patient with 4 services in one day = should count as 4
  - Manual count = 90 infusions â†’ dashboard must show 90
- [ ] Fix formula error showing 6,000+ (likely adding wrong columns)

### Task 2.2: Fix Injection Count Logic
**CRITICAL**: System must count SERVICES, not PATIENTS
- [ ] Remove patient-level consolidation logic for injections
- [ ] Count each individual injection service
- [ ] Filter by description contains injection-related keywords
- [ ] Test case: Lance Beal with 4 injections = should count as 4 separate services

### Task 2.3: Add Service-Level vs Patient-Level Toggle (Future Enhancement)
- [ ] Document that partners may want BOTH views:
  - Service count (how many services performed)
  - Patient count (how many unique patients)
- [ ] Consider adding both metrics to dashboard
- [ ] For now: DEFAULT to service-level counting

### Task 2.4: Verify Service Type Identification
- [ ] Review service type mapping (infusions vs injections vs other)
- [ ] Ensure all service descriptions are correctly categorized
- [ ] Reference the service line list that was previously sent
- [ ] Add logging for any unrecognized service descriptions

## Priority 3: Non-Member Customer Analytics Fix

### Task 3.1: Fix Non-Member Detection
- [ ] Current issue: Dashboard shows 0 non-member customers
- [ ] Review filter logic for identifying non-members
- [ ] Test with known data: Test week had multiple non-member visits
- [ ] Ensure filter correctly identifies members vs non-members

### Task 3.2: Verify Customer Analytics Calculations
- [ ] Review "unique customers" calculation (currently showing large numbers)
- [ ] Validate against manual count (30-40 patients per day mentioned)
- [ ] Add clear definition of what "unique customers" means in code comments

## Priority 4: File Upload Support

### Task 4.1: Add XLSX Format Support
- [ ] Current: Only XLS format from Optimatra works
- [ ] Need: Support XLSX format from Google Sheets
- [ ] Update file parsing logic to handle both formats
- [ ] Test with both file types

### Task 4.2: Verify Membership Schema
- [ ] Review expected column structure for membership uploads
- [ ] Document required columns and format
- [ ] Add validation to show helpful errors if schema doesn't match

### Task 4.3: Remove "New" Membership Logic
- [ ] Current: System may be looking for "new" in membership descriptions
- [ ] Reality: "new" is just an internal staff note about plan type
- [ ] Remove any logic filtering by "new" keyword in memberships

## Priority 5: Data Validation & Testing

### Task 5.1: Create Test Data Set
- [ ] Use the week of July 5-11, 2025 as test case
- [ ] Expected values:
  - Weight Loss Income: $10,199
  - Total Revenue: $16,560.20
  - Infusions: 90 services
  - Injections: Multiple (need exact count from manual review)
  - Non-member customers: >0

### Task 5.2: Add Data Validation Endpoint
- [ ] Create `/api/validate` endpoint that shows:
  - What filters were applied
  - What was included/excluded
  - Count breakdowns by category
  - Total calculations with itemization

### Task 5.3: Add Detailed Logging
- [ ] Log each filtering decision during data processing
- [ ] Show which services were counted and why
- [ ] Show which services were excluded and why
- [ ] Make logs accessible for debugging

## Priority 6: Edge Cases & Data Quality

### Task 6.1: Handle Multiple Services Per Patient
- [ ] Verify system correctly counts when patient has 4+ services same day
- [ ] Ensure no deduplication at patient level (only service level)
- [ ] Test with Nicholas Touchette example (4 services, lines 23-26)

### Task 6.2: Handle Zero-Dollar Services
- [ ] Document: Free consultations ($0) won't appear in Optimatra reports
- [ ] Note: This is Optimatra limitation, not fixable in dashboard
- [ ] Add note in dashboard UI about consultation counts

### Task 6.3: Handle Concierge + Drip Combo Memberships
- [ ] Document: Some members pay for BOTH concierge and drip
- [ ] Current: Appears in both categories (14 concierge, 4 overlap with individual)
- [ ] Decision needed: Count as one member or two memberships?
- [ ] For now: Count total of 111 members across all types

## Testing & Deployment

### Task 7.1: Local Testing in Windsurf
- [ ] Spin up local development environment
- [ ] Load test data (July 5-11, 2025)
- [ ] Verify all calculations match manual Excel results
- [ ] Test file uploads (both XLS and XLSX)
- [ ] Check all dashboard metrics display correctly

### Task 7.2: Create Test Script
- [ ] Automated test that validates:
  - Revenue calculations
  - Service counts
  - Non-member detection
  - File upload processing
- [ ] Use known expected values from test week

### Task 7.3: Pre-Deployment Checklist
- [ ] All revenue calculations match manual Excel
- [ ] Service counts match manual counts
- [ ] Non-member customers display correctly
- [ ] Both file formats upload successfully
- [ ] No console errors in browser
- [ ] Database schema changes documented

### Task 7.4: Deploy to Railway
- [ ] Run database migrations if needed
- [ ] Push code to GitHub (auto-deploys to Railway)
- [ ] Verify deployment health check
- [ ] Test with production data
- [ ] Monitor logs for any errors

## Documentation

### Task 8.1: Update Code Comments
- [ ] Document all filtering rules with examples
- [ ] Explain service-level vs patient-level counting decision
- [ ] Note Optimatra limitations (zero-dollar services)
- [ ] Add inline comments for complex regex patterns

### Task 8.2: Email to Client
- [ ] Prepare summary of what was fixed
- [ ] List any questions that need client clarification
- [ ] Document any edge cases that need business decisions
- [ ] Request testing/validation from Megan

## Questions to Email Megan (if needed)

1. Should we count services or patients for infusions/injections?
   - Current fix: Counting services (each individual service)
   - Alternative: Could provide both metrics

2. How should concierge + drip combo memberships be counted?
   - As one member with multiple memberships?
   - Or as separate entries?

3. Can you provide the complete service line list again?
   - Need to verify all service type mappings are correct
```

---

## Recommended Windsurf Approach

**Step 1**: Have agents review existing code structure
```
Please review:
- server.js (especially extractFromPDF and extractAnalyticsData functions)
- Current filtering logic for revenue and service counts
- File upload handling code
```

**Step 2**: Start with Priority 1 (Revenue) - highest impact
```
Focus on revenue calculation discrepancies first - this is the most critical business metric
```

**Step 3**: Move to Priority 2 (Service Counts) - core analytics
```
Fix service counting logic - must count services not patients
Step 4: Complete remaining priorities in order
Step 5: Comprehensive local testing before deploy
```

---

## SESSION SUMMARY - January 21, 2026

### Completed Tasks
âœ… **Task 1.1**: Revenue Filtering Logic Review
âœ… **Task 1.3**: IV Therapy Revenue Calculation Fix

### Changes Made

#### File: `server.js` (lines 1939-2027)
**Problem**: IV therapy revenue only counted visits with base infusions, missing $1,398.60 in revenue from:
- Standalone add-ons (NAD 250mg, NAD 200mg, HD Vitamin C)
- Standalone injections (Xeomin, B12, Vitamin D3)
- Add-on only visits without base infusions

**Solution**: 
- Introduced `isIVTherapyVisit` flag that includes base infusions, standalone injections, AND add-on only visits
- Properly excludes weight loss, membership, hormone, and lab-only services
- Consolidated revenue tracking to prevent double-counting
- Revenue now added once at the end for all IV-related visits

**Code Logic**:
```javascript
isIVTherapyVisit = hasBaseInfusion || hasStandaloneInjection
if (!isIVTherapyVisit) {
  // Check for add-ons without base infusion
  if (hasIVAddon && !hasWeightLoss && !hasHormone && !hasAdminOnly) {
    isIVTherapyVisit = true
  }
}
if (isIVTherapyVisit) {
  infusionWeeklyRevenue += totalAmount  // Add revenue once
}
```

### Documentation Created
1. `REVENUE_FIX_JAN_5_11.md` - Technical analysis and implementation details
2. `TASK_1.1_COMPLETION_SUMMARY.md` - Executive summary of fix
3. `diagnose-jan-5-11.js` - Database diagnostic script (for analysis)

### Deployment
- âœ… Changes committed to git
- âœ… Pushed to GitHub (main branch)
- ðŸš€ Railway automatic redeployment triggered

### Expected Results (Post-Deployment)
- **IV Therapy Revenue**: $15,060.60 â†’ ~$16,459.20 (+$1,398.60)
- **Weight Loss Revenue**: Unchanged
- **Membership Revenue**: Unchanged
- **Total Revenue**: Should align with file totals

### Next Steps
1. Monitor Railway deployment completion
2. Re-upload Jan 5-11, 2026 data to verify fix
3. Validate all revenue categories are accurate
4. Investigate $146.70 total discrepancy if it persists (30,905.82 vs 30,759.12)
5. Move to Task 1.2 (Weight Loss) and Task 2.x (Service Counts) if needed

### Technical Debt / Notes
- Database is on Railway (PostgreSQL), no local .env file
- npm dependencies installed successfully
- No GSD directory structure exists (MODE 3: NO PROJECT STRUCTURE)
- Session GSD focus file being used as task tracker per Codex's planning

---

## SESSION SUMMARY - January 21, 2026 (Part 2)

### Completed Tasks
âœ… **Task 1.2**: Weight Loss Revenue - Row-level aggregation with semaglutide/tirzepatide/contrave keywords
âœ… **Task 2.x**: Service Counts - Row-level with Qty multiplier, removed visitMap logic
âœ… **Task 3.x**: Non-Member Analytics - Row-level customer tracking
âœ… **Task 4.1**: UTF-16 TSV fallback for .xls files
âœ… **Task 4.2**: Membership upload validation
âœ… **Task 4.3**: Removed "NEW" keyword dependency
âœ… **Task 5.2**: Created /api/validate endpoint

### Major Changes Made

#### Core Architecture: Visit-Level â†’ Row-Level Processing
**File**: `server.js` (lines 1689-1890)

**Problem**: System was aggregating services by patient+date (visitMap), causing:
- Service counts to reflect visits, not actual services
- Potential revenue loss from missed line items
- Incorrect non-member customer counts

**Solution**: Complete rewrite to process each CSV row individually:
```javascript
// OLD: visitMap.forEach((visit) => { ... })
// NEW: filteredData.forEach(row => { ... })
```

**Impact**:
- Infusion counts now show actual service volume (e.g., 90 instead of ~30)
- Weight loss revenue sums all matching rows individually
- Non-member customers tracked correctly via row-level patient detection

#### Task 1.2: Weight Loss Revenue
- **Keywords**: `semaglutide`, `tirzepatide`, `contrave`
- **Method**: Row-level sum with Qty multiplier
- **Expected**: $10,199 for test week

#### Task 2.x: Service Counts
- **Infusions**: Row-level count with Qty multiplier
- **Injections**: Row-level count with Qty multiplier
- **Add-ons**: Count toward revenue, not as separate services
- **Expected**: 90 infusions for test week

#### Task 3.x: Customer Analytics
- **Member Detection**: `includes('member') && !includes('non-member')`
- **Unique Tracking**: `Set()` for weekly/monthly customers
- **Expected**: Non-member count > 0 (was showing 0)

#### Task 4.1: File Upload Support
- **UTF-16 TSV Fallback**: When XLSX parsing fails
- **Detection**: BOM bytes (0xFF 0xFE or 0xFE 0xFF)
- **Parsing**: iconv-lite decode â†’ TSV split â†’ JSON conversion

#### Task 4.2: Membership Validation
- **Required Columns**: name, email, type
- **Flexible Matching**: Multiple column name variations
- **Error Handling**: Clear message with missing columns

#### Task 4.3: Membership Logic Fix
- **Removed**: "NEW" keyword dependency
- **New Logic**: Date range only - any membership transaction in week counts as new
- **Reason**: "NEW" is just a staff note, not reliable

#### Task 5.2: Validation Endpoint
**Endpoint**: `POST /api/validate`
**Returns**:
- Filters applied
- Included/excluded counts
- Rollups by category (count + revenue)
- Sample rows (up to 20 per category)
- Date range detected from data

### Documentation Created
1. `TASK_1.2-5.2_COMPLETION_SUMMARY.md` - Comprehensive technical summary

### Deployment
- âœ… All changes implemented in `server.js`
- ðŸš€ Ready for commit and push to Railway
- ðŸ“Š Expected to fix all reported calculation issues

### Expected Results (Post-Deployment)
- **Weight Loss Revenue**: $10,199.00 âœ“
- **IV Therapy Revenue**: $16,459.20 âœ“
- **Infusion Count**: 90 services âœ“
- **Non-Member Customers**: > 0 âœ“
- **Total Revenue**: $30,759.12 âœ“

### Testing Checklist
- [ ] Upload Jan 5-11, 2026 file
- [ ] Verify weight loss revenue = $10,199
- [ ] Verify IV therapy revenue = $16,459.20
- [ ] Verify infusion count = 90
- [ ] Verify non-member customers > 0
- [ ] Test /api/validate endpoint
- [ ] Test UTF-16 .xls file upload

### Technical Notes
- **Row-Level Processing**: More accurate and efficient than visitMap
- **Qty Multiplier**: Applied to all service counts
- **Backward Compatibility**: Legacy fields maintained
- **No Schema Changes**: Uses existing database columns